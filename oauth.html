<!-- Reinitialize Link on this page in the body via a script,
  redirect them back to home page
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
    <title></title>
  </head>
  <body>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script>
      (($) => {
        const linkToken = localStorage.getItem("link_token");

        const handler = Plaid.create({
          token: linkToken,
          receivedRedirectUri: window.location.href,
          onSuccess: async (publicToken, metadata) => {
            await fetch('/api/exchange-public-token', {
              method: 'POST',
              body: JSON.stringify({ "public_token": publicToken }),
              headers: {
                'Content-Type': 'application/json',
              },
            });

            const response = await fetch('/api/data', {
              method: 'GET',
            });
            const data = await response.json();
            localStorage.setItem('transactions', JSON.stringify(data));
            location.href = "http://localhost:3002";
          },
        });

        handler.open();
      })(jQuery);
    </script>
  
  </body>
</html>